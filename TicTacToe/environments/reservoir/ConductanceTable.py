from typing import Dict, Tuple
import numpy as np


# Assume this table converts 4-bit sequences to float values
class ConductanceTable:
    def __init__(self, name: str,
                 table: Dict[Tuple, Tuple[float, float]]):
        self.table = table
        self.name = name
        self.table_min = min(
            [value[0] for value in table.values()]) * 0.93
        self.table_max = max(
            [value[0] for value in table.values()]) * 1.05

    def encode_4_bits(self, bits, sample: int):
        assert len(bits) == 4, "there has to be 4 bits. Got {}".format(
            len(bits))
        value_and_error = self.table[tuple(bits)]
        if sample != 0:
            return [
                max(min(
                    np.random.normal(value_and_error[0], value_and_error[1]),
                    self.table_max), self.table_min)
                for _ in range(sample)]
        else:
            return [value_and_error[0]]

    def encode_all_bits(self, bits, sample: int, padding=0):
        bits_tail = len(bits) % 4
        if bits_tail != 0:
            bits = bits + [padding for _ in range(4 - bits_tail)]
        encoded_bits = []
        # len(bits) is divisible by 4.
        for index in range(0, len(bits), 4):
            encoded = self.encode_4_bits(
                bits[index:index + 4], sample)
            encoded_bits += encoded
            # print(bits[index:index + 4], encoded)
        # print("")
        return np.array(encoded_bits, dtype=np.float32)


original_table = ConductanceTable("Original", {
    (0, 0, 0, 0): (0.6344719, 0.00795708),
    (0, 0, 0, 1): (1.295158482, 0.018508253),
    (0, 0, 1, 0): (0.732387046, 0.00857042),
    (0, 0, 1, 1): (1.513310788, 0.019179896),
    (0, 1, 0, 0): (0.653960243, 0.008624319),
    (0, 1, 0, 1): (1.403799596, 0.024181049),
    (0, 1, 1, 0): (0.812054838, 0.007432739),
    (0, 1, 1, 1): (1.690582836, 0.031750193),
    (1, 0, 0, 0): (0.633037114, 0.013263677),
    (1, 0, 0, 1): (1.350882082, 0.023577157),
    (1, 0, 1, 0): (0.834046672, 0.024497146),
    (1, 0, 1, 1): (1.631329556, 0.04620028),
    (1, 1, 0, 0): (0.708502949, 0.01601286),
    (1, 1, 0, 1): (1.496165371, 0.021980554),
    (1, 1, 1, 0): (0.949045017, 0.015482592),
    (1, 1, 1, 1): (1.796519291, 0.013471359),
})

table_5_1_0_2s = ConductanceTable("5_1_0.2s", {
    (0, 0, 0, 0): (0.987377, 0.00396713),
    (0, 0, 0, 1): (0.989683, 0.00444871),
    (0, 0, 1, 0): (0.991021, 0.00467026),
    (0, 0, 1, 1): (1.00045, 0.00242486),
    (0, 1, 0, 0): (0.994617, 0.00162339),
    (0, 1, 0, 1): (1.00031, 0.00449871),
    (0, 1, 1, 0): (1.00867, 0.00423243),
    (0, 1, 1, 1): (1.00315, 0.00435497),
    (1, 0, 0, 0): (0.995941, 0.000641005),
    (1, 0, 0, 1): (1.00011, 0.00135755),
    (1, 0, 1, 0): (1.00433, 0.00600942),
    (1, 0, 1, 1): (1.00396, 0.00722354),
    (1, 1, 0, 0): (1.00668, 0.00623833),
    (1, 1, 0, 1): (1.01243, 0.00382767),
    (1, 1, 1, 0): (1.01238, 0.00198967),
    (1, 1, 1, 1): (1.01533, 0.00266722),
})

table_5_2_0_5s = ConductanceTable("5_2_0.5s", {
    (0, 0, 0, 0): (0.956399, 0.00395933),
    (0, 0, 0, 1): (0.976081, 0.00616098),
    (0, 0, 1, 0): (0.980052, 0.00896944),
    (0, 0, 1, 1): (1.0012, 0.00480038),
    (0, 1, 0, 0): (0.981378, 0.00689275),
    (0, 1, 0, 1): (1.00083, 0.00956193),
    (0, 1, 1, 0): (0.999374, 0.00970276),
    (0, 1, 1, 1): (1.02982, 0.00558956),
    (1, 0, 0, 0): (0.989387, 0.00359699),
    (1, 0, 0, 1): (1.00694, 0.00553841),
    (1, 0, 1, 0): (1.01068, 0.00989243),
    (1, 0, 1, 1): (1.03029, 0.00950179),
    (1, 1, 0, 0): (1.00733, 0.00521794),
    (1, 1, 0, 1): (1.02451, 0.00623088),
    (1, 1, 1, 0): (1.03159, 0.00643488),
    (1, 1, 1, 1): (1.05979, 0.00879871),
})

table_5_3_1s = ConductanceTable("5_3_1s", {
    (0, 0, 0, 0): (0.916747, 0.0084542),
    (0, 0, 0, 1): (0.967789, 0.00727386),
    (0, 0, 1, 0): (0.966618, 0.00615339),
    (0, 0, 1, 1): (1.00707, 0.00526465),
    (0, 1, 0, 0): (0.965081, 0.0109798),
    (0, 1, 0, 1): (1.01218, 0.00409874),
    (0, 1, 1, 0): (1.02351, 0.0123359),
    (0, 1, 1, 1): (1.07048, 0.0066612),
    (1, 0, 0, 0): (0.962488, 0.00441754),
    (1, 0, 0, 1): (0.995444, 0.0067351),
    (1, 0, 1, 0): (1.01003, 0.00292128),
    (1, 0, 1, 1): (1.05933, 0.00628634),
    (1, 1, 0, 0): (1.00964, 0.00485916),
    (1, 1, 0, 1): (1.05028, 0.0133355),
    (1, 1, 1, 0): (1.06651, 0.00267115),
    (1, 1, 1, 1): (1.11231, 0.00800602),
})

table_5_4_2s = ConductanceTable("5_4_2s", {
    (0, 0, 0, 0): (0.872897, 0.00913573),
    (0, 0, 0, 1): (0.955119, 0.00994401),
    (0, 0, 1, 0): (0.950664, 0.00499584),
    (0, 0, 1, 1): (1.06594, 0.00291706),
    (0, 1, 0, 0): (0.939997, 0.0130017),
    (0, 1, 0, 1): (1.03647, 0.00726671),
    (0, 1, 1, 0): (1.02926, 0.00553335),
    (0, 1, 1, 1): (1.11674, 0.00419065),
    (1, 0, 0, 0): (0.929698, 0.0140383),
    (1, 0, 0, 1): (1.01896, 0.00941638),
    (1, 0, 1, 0): (1.02133, 0.014945),
    (1, 0, 1, 1): (1.10289, 0.00911795),
    (1, 1, 0, 0): (0.994891, 0.0103278),
    (1, 1, 0, 1): (1.07921, 0.00804887),
    (1, 1, 1, 0): (1.06989, 0.00902782),
    (1, 1, 1, 1): (1.16838, 0.021618),
})

table_5_5_1s_0_2s = ConductanceTable("5_5_1s_0.2s", {
    (0, 0, 0, 0): (0.925661, 0.00710766),
    (0, 0, 0, 1): (0.958343, 0.00488063),
    (0, 0, 1, 0): (0.964098, 0.00112061),
    (0, 0, 1, 1): (1.00588, 0.00951777),
    (0, 1, 0, 0): (0.975979, 0.0066628),
    (0, 1, 0, 1): (1.0103, 0.0101457),
    (0, 1, 1, 0): (1.02144, 0.00329511),
    (0, 1, 1, 1): (1.05772, 0.0120832),
    (1, 0, 0, 0): (0.973326, 0.00621919),
    (1, 0, 0, 1): (1.00505, 0.00455115),
    (1, 0, 1, 0): (1.01206, 0.00535538),
    (1, 0, 1, 1): (1.0551, 0.00589065),
    (1, 1, 0, 0): (1.01643, 0.00630473),
    (1, 1, 0, 1): (1.05495, 0.0028285),
    (1, 1, 1, 0): (1.06838, 0.00635839),
    (1, 1, 1, 1): (1.11048, 0.00877355),
})

table_5_6_1s_0_5s = ConductanceTable("5_6_1s_0.5s", {
    (0, 0, 0, 0): (0.921519, 0.00890053),
    (0, 0, 0, 1): (0.959598, 0.00480936),
    (0, 0, 1, 0): (0.96866, 0.00795419),
    (0, 0, 1, 1): (1.01829, 0.00713726),
    (0, 1, 0, 0): (0.967549, 0.00343194),
    (0, 1, 0, 1): (1.00797, 0.00715338),
    (0, 1, 1, 0): (1.01815, 0.00970381),
    (0, 1, 1, 1): (1.05512, 0.0132692),
    (1, 0, 0, 0): (0.961682, 0.0102734),
    (1, 0, 0, 1): (0.99988, 0.00668336),
    (1, 0, 1, 0): (1.00817, 0.0038948),
    (1, 0, 1, 1): (1.0427, 0.00488225),
    (1, 1, 0, 0): (1.00645, 0.00932436),
    (1, 1, 0, 1): (1.05873, 0.0114617),
    (1, 1, 1, 0): (1.06288, 0.00951444),
    (1, 1, 1, 1): (1.10198, 0.00661342),
})

table_5_7_2s_0_5s = ConductanceTable("5_7_2s_0.5s", {
    (0, 0, 0, 0): (0.850571, 0.00504722),
    (0, 0, 0, 1): (0.940695, 0.00238888),
    (0, 0, 1, 0): (0.948929, 0.00372315),
    (0, 0, 1, 1): (1.04474, 0.00772804),
    (0, 1, 0, 0): (0.938682, 0.012612),
    (0, 1, 0, 1): (1.01794, 0.00607652),
    (0, 1, 1, 0): (1.03599, 0.00903903),
    (0, 1, 1, 1): (1.137, 0.0123226),
    (1, 0, 0, 0): (0.931756, 0.0087798),
    (1, 0, 0, 1): (1.00532, 0.00953436),
    (1, 0, 1, 0): (1.02082, 0.00310166),
    (1, 0, 1, 1): (1.11445, 0.00572986),
    (1, 1, 0, 0): (1.00932, 0.00640623),
    (1, 1, 0, 1): (1.10126, 0.0112207),
    (1, 1, 1, 0): (1.11958, 0.00816897),
    (1, 1, 1, 1): (1.20529, 0.00387723),
})
